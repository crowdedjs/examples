<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>Single Crowd Simulator</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" type="text/css" href="./three.css">
</head>

<body>

  <script src="./lib/axios.js"></script> <!-- Promise-based AJAX library-->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@ricksteam/fluent-behavior-tree-browser/bundle.js"></script> -->
  <script src="./lib/bundle.js"></script> <!-- Our port of fluent-behvaior-tree-browser-->
  <script src="./worker.js"></script> <!-- Our port of RecastDetour-->
  <!-- <script src="./bundle.js"></script> Our port of RecastDetour -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@crowdedjs/computer/EDComputer.js"></script> -->
  <script type="module">
    //Show FPS Counter
    //Comment this line if you don't want to show the FPS counter
    javascript: (function () { var script = document.createElement('script'); script.onload = function () { var stats = new Stats(); document.body.appendChild(stats.dom); requestAnimationFrame(function loop() { stats.update(); requestAnimationFrame(loop) }); }; script.src = '//mrdoob.github.io/stats.js/build/stats.min.js'; document.head.appendChild(script); })()

    import MedicalAgent from "./people/medical-agent.js"
    import PatientAgent from "./people/patient-agent.js"
    import CrowdSetup from "./crowd-setup/index.js"
    //import CrowdSetup from "http://localhost:5500/index.js"
    // import CrowdSetup from "https://cdn.jsdelivr.net/npm/@crowdedjs/crowd-setup@0.0.5/index.js"
    import urlParser from "./urlParser.js"
    import colorFunction from "./color-function.js"
    import simulations from "./simulations.js"
    import HospitalClass from "./support/hospital.js"
    //import * as Computer from "http://127.0.0.1:5501/EDComputer.js"
    import Computer from "./support/Computer.js"
    import Room from "./support/room.js"
    import Vector3 from "./math/vector3.js"



    let params = {};
    let assetBase = "./";
    //let assetBase = "https://cdn.jsdelivr.net/npm/@crowdedjs/assets/";
    params.objPath = assetBase + "objs/hospital-flat.obj";
    // params.objPath = assetBase + "objs/hospital.obj";
    // params.arrivalPath = assetBase + "arrivals/arrivalHospital.json";
    params.arrivalPath = "./" + "arrivals/arrivalHospital.json";
    params.secondsOfSimulation = 300;
    params.millisecondsBetweenFrames = 40;
    // params.locationsPath = assetBase + "locations/locationsHospital.json";
    params.locationsPath = "./" + "locations/locationsHospital.json";

    params = urlParser(window, params, assetBase);

    window.Hospital = HospitalClass;
    window.Vector3 = Vector3;

    let promises = [axios.get(params.objPath), axios.get(params.locationsPath), axios.get(params.arrivalPath)];
    Promise.all(promises)
      .then(results => {
        let objValue = results[0].data;       //Grab the value of the environment 
        let locationValue = JSON.parse(results[1].data);  //Grab the value of all the locations
        let arrivalValue = JSON.parse(results[2].data);   //Grab the value of all the arrivals

        let agentConstants = [];  //An array with all the high-level agent information (not the simulation data)
        let locations = [];

        //Add an agent with a behavior and an id
        arrivalValue.forEach((agent, index) => {
          if (agent.name == "patient")
            agentConstants.push(new PatientAgent(agent, locationValue));
          else
            agentConstants.push(new MedicalAgent(agent, locationValue));
          //Is this line necessary?
          agentConstants[agentConstants.length - 1].setId(index);
        })

        locationValue.forEach(l => {
          locations.push(new Room(l.position, l.annotationName.toUpperCase().replace(" ", "_"), l.name))
        })


        Hospital.agents = agentConstants;
        Hospital.locations = locations;
        Hospital.computer = new Computer();



        //Start the simulation.
        new CrowdSetup(objValue, agentConstants, params.secondsOfSimulation, params.millisecondsBetweenFrames, locationValue, window, document.body, colorFunction, simulations, "./crowd-setup/"/*"https://cdn.jsdelivr.net/npm/@crowdedjs/crowd-setup"*/);

      })
      // This is commented out for debugging purposes. In production, this should be added back in.
      // .catch(error => {
      //   console.log("Error in the app " + error)
      // })


  </script>
</body>

</html>