<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>Single Crowd Simulator</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" type="text/css" href="./three.css">
</head>

<body>

  <script src="./lib/axios.js"></script> <!-- Promise-based AJAX library-->
  <script src="./lib/lodash.js"></script> <!-- Standard JS Utility Library-->

  <script src="https://cdn.jsdelivr.net/npm/@ricksteam/fluent-behavior-tree-browser@0.2.0/bundle.js"></script>

  <script src="./worker.js"></script> <!-- Our port of RecastDetour-->
  
  <script src="//mrdoob.github.io/stats.js/build/stats.min.js"></script>

  <script type="module">
    
    //Show FPS Counter
    //Comment this line if you don't want to show the FPS counter
    // SCORING FUNCTION GRAPH
    //javascript: (function () { var script = document.createElement('script'); script.onload = function () { var stats = new Stats(); document.body.appendChild(stats.dom); requestAnimationFrame(function loop() { stats.update(); requestAnimationFrame(loop) }); }; script.src = '//mrdoob.github.io/stats.js/build/stats.min.js'; document.head.appendChild(script); })()
    
    var stats = new Stats();
    //AGENTS IN SIMULATION PER FRAME
    var xPanel = stats.addPanel( new Stats.Panel( 'AGENTS', '#ff8', '#221' ) );
    //var yPanel = stats.addPanel( new Stats.Panel( 'y', '#f8f', '#212' ) );
    stats.showPanel(2);
    stats.dom.style.position = 'fixed';
    stats.dom.style.float = 'left';
    document.body.appendChild( stats.dom );

    function animate() {
      //xPanel.update(agentPositionsRef[agentPositionsRef.length].length);
      xPanel.update(1);
      stats.update();

      requestAnimationFrame( animate );

    }

    animate();

    
    import MedicalAgent from "./people/medical-agent.js"
    import PatientAgent from "./people/patient-agent.js"
    import CrowdSetup from "./crowd-setup/index.js"
    import urlParser from "./url-parser.js"
    import colorFunction from "./color-function.js"
    import simulations from "./simulations.js"
    import HospitalClass from "./support/hospital.js"
    import Computer from "./support/Computer.js"
    import Room from "./support/room.js"
    import Vector3 from "./math/vector-3.js"

    import index from "./crowd-setup/index.js"

    let params = {};

    //Change to the cdn in production
    let assetBase = "./";
    //let assetBase = "https://cdn.jsdelivr.net/npm/@crowdedjs/assets/";

    //Flat hospital removes the walls to speed up debugging
    //params.objPath = assetBase + "objs/hospital-flat.obj";
     params.objPath = assetBase + "objs/hospital.obj";

    //
    params.arrivalPath = assetBase + "arrivals/arrivalHospital.json";
    //params.arrivalPath = "./" + "arrivals/arrivalHospital.json";

    params.locationsPath = "./" + "locations/locationsHospital.json";

    //This does not represent seconds any more
    params.secondsOfSimulation = 300;
    params.millisecondsBetweenFrames = 40;
    

    params = urlParser(window, params, assetBase);

    //Set these up as global variables
    window.Hospital = HospitalClass;
    window.Vector3 = Vector3;

    //Grab the information about our simulaiton
    let promises = [axios.get(params.objPath), axios.get(params.locationsPath), axios.get(params.arrivalPath)];
    Promise.all(promises)
      .then(results => {
        let objValue = results[0].data;       //Grab the value of the environment 
        let locationValue = JSON.parse(results[1].data);  //Grab the value of all the locations
        let arrivalValue = JSON.parse(results[2].data);   //Grab the value of all the arrivals

        let agentConstants = [];  //An array with all the high-level agent information (not the simulation data)
        let locations = [];

        //Add an agent with a behavior and an id
        arrivalValue.forEach((agent, index) => {
          if (agent.name == "patient")
            agentConstants.push(new PatientAgent(agent, locationValue));
          else
            agentConstants.push(new MedicalAgent(agent, locationValue));
          //Is this line necessary?
          agentConstants[agentConstants.length - 1].setId(index);
        })

        //Remove spaces in annotation names
        locationValue.forEach(l => {
          locations.push(new Room(l.position, l.annotationName.toUpperCase().replace(" ", "_"), l.name))
        })

        //Assign the data to the global hospital object
        Hospital.agents = agentConstants;
        Hospital.locations = locations;
        Hospital.computer = new Computer();

        //Start the simulation.
        new CrowdSetup(objValue, agentConstants, params.secondsOfSimulation, params.millisecondsBetweenFrames, locationValue, window, document.body, colorFunction, simulations, "./crowd-setup/");

      })
      //This can be commented out for debugging purposes. In production, this should not be commented.
      .catch(error => {
        console.log("Error in the app " + error)
      })


  </script>

</body>

</html>